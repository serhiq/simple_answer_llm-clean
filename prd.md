# PRD v0.0 — CLI PoC: AI-ассистент поверх Эвотора (read-only, Go)

## 1) Цель

Сделать **элементарный CLI-инструмент на Go** для проверки концепции “LLM-агент + тулы (Evotor API)”

Инструмент должен:

* принимать запрос текстом (RU),
* дергать Evotor API через ограниченный набор функций,
* возвращать **проверяемые** ответы (id/поля из API),
* логировать вызовы и результаты для оценки качества/скорости/стоимости.

---

## 3) Пользователь

Разработчик/тимлид/аналитик, который гоняет запросы на данных клиента.

---

## 4) Definition of Done (приёмка)

Готово, если:

1. CLI работает в интерактивном (REPL) и one-shot режиме.
2. Реализованы 4 тулзы (раздел 6) и агент вызывает их корректно.
3. Поддержаны 3 сценария (раздел 5).
4. Есть `--debug` и лог-файл с полным трейсом tool calls (args/ms/status).
5. Ответы содержат **id** найденных сущностей и ключевые поля. Ничего не придумывается.
6. Есть `README.md` + `.env.example` + `tests.md` (10–15 запросов).

---

## 5) Сценарии (обязательно)

### S1 — Поиск чека/документа по товару и периоду

Пример: `Найди чек в декабре где была позиция "лак для волос"`
Ожидание:

* применённый период (если год не указан — текущий год и явно написать; в REPL можно уточнить),
* до N результатов (N=10): `doc_id`, дата/время, сумма, store/device (если доступно),
* если много — первые N + предложение уточнить.

### S2 — Поиск товара по названию

Пример: `Найди товар "лак для волос"`
Ожидание:

* до N позиций: `item_id`, название, цена/артикул/штрихкод (если есть).

### S3 — Простой подсчёт

Пример: `Сумма продаж за вчера` / `Сколько чеков за вчера`
Ожидание:

* сумма/кол-во,
* период и фильтры,
* кратко: по каким документам считали (если типы известны).

---

## 6) API-тулы (обязательно реализовать, read-only)

> Важно: тулзы делают **только** сетевые вызовы/простую локальную фильтрацию. Вся “логика рассуждения” — в LLM.

### T1 `ListStores(ctx) ([]Store, error)`

* Возвращает: `store_id`, `name`

### T2 `SearchItems(ctx, query string, limit int) ([]Item, error)`

* Возвращает: `item_id`, `name`, доп. поля (если есть)

### T3 `SearchDocuments(ctx, from, to time.Time, storeID *string, limit, offset int) ([]DocumentShort, error)`

* Возвращает: `doc_id`, `timestamp`, `total`, `store_id`, `device_id`

### T4 `GetDocument(ctx, docID string) (DocumentFull, error)`

* Возвращает: `doc_id`, `timestamp`, `total`, `positions[] {name, qty, price, sum}`, метаданные

**Фильтр “документ содержит товар X”:**

* v0: делаем локально: берём список документов за период → для каждого (в пределах лимита) `GetDocument` → проверяем позиции.

---

## 7) CLI интерфейс

### 7.1 One-shot

```bash
evotor-ai "Найди чек в декабре где была позиция лак для волос"
```

### 7.2 REPL

```bash
evotor-ai
> Сумма продаж за вчера
> Найди товар "лак для волос"
```

### 7.3 Флаги

* `--token <TOKEN>` (если нет env)
* `--store-id <ID>` (дефолтная точка)
* `--from YYYY-MM-DD` / `--to YYYY-MM-DD` (дефолтный период)
* `--json` (машинный вывод)
* `--debug` (stdout trace)
* `--log-file <path>` (default `./evotor-ai.log`)
* `--timeout <sec>` (default 20)

### 7.4 Env

* `EVOTOR_TOKEN`
* `EVOTOR_STORE_ID` (опционально)
* `LLM_BASE_URL` (OpenAI-compatible)
* `LLM_API_KEY`
* `LLM_MODEL`

---

## 8) LLM и оркестрация (требования)

### 8.1 Принцип

* Агентный цикл: **parse → plan → tool calls → compose answer**.
* Ответы **только по фактам** из tool results.
* При неоднозначности:

  * в REPL — 1 уточняющий вопрос,
  * в one-shot — выбрать дефолт и явно указать.

### 8.2 Реализация вызова модели

* Поддержать OpenAI-compatible Chat Completions:

  * system prompt + user prompt + tool schema
  * tool/function calling (если выбранный провайдер поддерживает)
* Используются модели с function-calling.

---

## 9) Формат ответа

### Человеческий (default)

* **Ответ**
* **Фильтры** (период/точка)
* **Результаты** (до 10 строк)
* **Следующий шаг** (одно уточнение)

### JSON (`--json`)

```json
{
  "query": "...",
  "applied_filters": { "date_from": "...", "date_to": "...", "store_id": "..." },
  "answer_text": "...",
  "results": [],
  "tool_calls": [
    { "name": "SearchDocuments", "args": {}, "ms": 1234, "ok": true, "err": "" }
  ]
}
```

---

## 10) Логирование

Писать в лог:

* запрос
* tool_calls (имя, args, ms, ok, err)
* итоговый ответ
* usage/cost (если есть в ответе провайдера; иначе пусто)

---

## 11) Ошибки и ретраи

* 401/403: “нет доступа/неверный токен”
* 429: 1 ретрай с backoff (1–2 сек), потом ошибка
* таймауты: 1 ретрай для Evotor API
* пусто: “не найдено” + уточнение

---

## 12) Ограничения по умолчанию

* Если период не указан: **последние 7 дней**.
* Если “декабрь” без года:

  * REPL: спросить год,
  * one-shot: взять текущий год и явно написать.
* Лимиты: documents=50 на запрос, вывод=10.

---

## 13) Артефакты поставки

* исходники (Go module)
* `README.md`
* `.env.example`
* `request.http` (10–15 запросов)
* бинарник `evotor-ai` (через `go build`)

---

## 14) Стек и требования к коду (Go)

* Go 1.24+
* "github.com/revrost/go-openrouter"
* CLI: standard library `flag`
* Логи: `zap` 
* Конфиг: env 


	github.com/go-core-fx/config v0.0.1
	github.com/go-core-fx/fiberfx v0.0.1
	github.com/go-core-fx/logger v0.0.1
	github.com/go-core-fx/validator v0.0.0-20251027105711-abf1d955722d
	github.com/gofiber/fiber/v2 v2.52.9
	github.com/revrost/go-openrouter v1.0.1
	
	
Ссылка
api
https://developer.evotor.ru/docs/rest_smart_terminals.html



	


 
